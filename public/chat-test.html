<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akash Share - Chat Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #28a745; }
        .disconnected { background: #dc3545; }
        .connecting { background: #ffc107; color: black; }
        input, button { padding: 10px; margin: 5px; border: none; border-radius: 5px; }
        input { background: #333; color: white; width: 200px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        .messages { background: #333; padding: 15px; border-radius: 5px; height: 300px; overflow-y: scroll; margin: 10px 0; }
        .message { margin: 5px 0; padding: 5px; background: #444; border-radius: 3px; }
        .users { background: #2d2d2d; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Akash Share - Cross-Device Chat Test</h1>
        
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div>
            <input type="text" id="username" placeholder="Enter your username" value="">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>
        
        <div>
            <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">Send</button>
        </div>
        
        <div class="users">
            <h3>Online Users:</h3>
            <div id="users">None</div>
        </div>
        
        <div class="messages" id="messages"></div>
        
        <div style="margin-top: 20px; padding: 10px; background: #2d2d2d; border-radius: 5px;">
            <h3>Instructions:</h3>
            <p><strong>For Laptop:</strong> Access via <code>http://localhost:3001</code> or <code>http://192.168.0.185:3001</code></p>
            <p><strong>For Mobile:</strong> Access via <code>http://192.168.0.185:3001</code> (same WiFi network)</p>
            <p><strong>Test:</strong> Both devices should connect to the same server and see each other's messages!</p>
        </div>
    </div>

    <script>
        let ws = null;
        let username = '';
        let isConnected = false;

        function updateStatus(message, className) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${className}`;
        }

        function addMessage(text, isSystem = false) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message';
            div.style.background = isSystem ? '#0056b3' : '#444';
            div.textContent = `${new Date().toLocaleTimeString()} - ${text}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateUsers(userList) {
            const users = document.getElementById('users');
            users.textContent = userList.length > 0 ? userList.join(', ') : 'None';
        }

        function connect() {
            username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            disconnect(); // Close existing connection if any

            const wsUrl = `ws://192.168.0.185:5002/chat?username=${encodeURIComponent(username)}&room=general`;
            
            updateStatus('Connecting...', 'connecting');
            addMessage(`Connecting to: ${wsUrl}`, true);

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                isConnected = true;
                updateStatus(`Connected as ${username}`, 'connected');
                addMessage(`âœ… Connected to chat server!`, true);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received:', data);

                    switch (data.type) {
                        case 'message':
                            addMessage(`${data.username}: ${data.message}`);
                            break;
                        case 'userJoined':
                            updateUsers(data.users);
                            addMessage(`ðŸ‘‹ ${data.username} joined the chat`, true);
                            break;
                        case 'userLeft':
                            updateUsers(data.users);
                            addMessage(`ðŸ‘‹ User left the chat`, true);
                            break;
                        case 'userList':
                            updateUsers(data.users);
                            break;
                    }
                } catch (error) {
                    console.error('Message parsing error:', error);
                }
            };

            ws.onclose = (event) => {
                isConnected = false;
                updateStatus('Disconnected', 'disconnected');
                addMessage(`âŒ Disconnected (Code: ${event.code})`, true);
            };

            ws.onerror = (error) => {
                isConnected = false;
                updateStatus('Connection Error', 'disconnected');
                addMessage(`ðŸš¨ Connection error: ${error}`, true);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            isConnected = false;
            updateStatus('Disconnected', 'disconnected');
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !isConnected || !ws) {
                alert('Please connect to chat first');
                return;
            }

            if (ws.readyState !== WebSocket.OPEN) {
                alert('Connection is not open');
                return;
            }

            try {
                const messageData = {
                    type: 'message',
                    message: message,
                    room: 'general',
                    timestamp: new Date().toISOString()
                };
                
                ws.send(JSON.stringify(messageData));
                messageInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-focus on username input
        document.getElementById('username').focus();
    </script>
</body>
</html>